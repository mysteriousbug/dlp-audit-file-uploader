create_visualizations(df, rca_results):
    """Create comprehensive visualizations for the RCA."""
    
    fig = plt.figure(figsize=(18, 12))
    gs = fig.add_gridspec(3, 3, hspace=0.35, wspace=0.3)
    
    fig.suptitle('Incident-Change Time Difference Root Cause Analysis', 
                 fontsize=16, fontweight='bold')
    
    # 1. Time Difference Distribution (Histogram)
    ax1 = fig.add_subplot(gs[0, :2])
    ax1.hist(df['total_hours']/24, bins=30, color='steelblue', edgecolor='black', alpha=0.7)
    ax1.axvline(df['total_hours'].mean()/24, color='red', linestyle='--', 
                label=f'Mean: {df["total_hours"].mean()/24:.1f} days', linewidth=2)
    ax1.axvline(df['total_hours'].median()/24, color='green', linestyle='--', 
                label=f'Median: {df["total_hours"].median()/24:.1f} days', linewidth=2)
    ax1.set_xlabel('Time Difference (days)', fontsize=10)
    ax1.set_ylabel('Frequency', fontsize=10)
    ax1.set_title('Time Difference Distribution', fontweight='bold')
    ax1.legend()
    ax1.grid(True, alpha=0.3)
    
    # 2. Time Buckets (Bar Chart)
    ax2 = fig.add_subplot(gs[0, 2])
    time_buckets = pd.Series(rca_results['time_buckets'])
    colors = plt.cm.RdYlGn_r(np.linspace(0.2, 0.9, len(time_buckets)))
    bars = ax2.barh(range(len(time_buckets)), time_buckets.values, color=colors)
    ax2.set_yticks(range(len(time_buckets)))
    ax2.set_yticklabels(time_buckets.index, fontsize=8)
    ax2.set_xlabel('Count', fontsize=10)
    ax2.set_title('Time Buckets', fontweight='bold')
    ax2.grid(True, alpha=0.3, axis='x')
    
    for i, bar in enumerate(bars):
        width = bar.get_width()
        ax2.text(width, bar.get_y() + bar.get_height()/2, 
                f'{int(width)}', ha='left', va='center', fontsize=8)
    
    # 3. Incident Impact Distribution
    ax3 = fig.add_subplot(gs[1, 0])
    inc_impact = df['incident.impact'].value_counts()
    colors_impact = plt.cm.RdYlGn_r(np.linspace(0.2, 0.8, len(inc_impact)))
    bars = ax3.bar(range(len(inc_impact)), inc_impact.values, color=colors_impact, alpha=0.7)
    ax3.set_xticks(range(len(inc_impact)))
    ax3.set_xticklabels([str(x)[:15] for x in inc_impact.index], rotation=45, ha='right', fontsize=8)
    ax3.set_ylabel('Count', fontsize=10)
    ax3.set_title('Incident Impact Distribution', fontweight='bold')
    ax3.grid(True, alpha=0.3, axis='y')
    
    for bar in bars:
        height = bar.get_height()
        if height > 0:
            ax3.text(bar.get_x() + bar.get_width()/2., height,
                    f'{int(height)}', ha='center', va='bottom', fontsize=8)
    
    # 4. Change Impact Distribution
    ax4 = fig.add_subplot(gs[1, 1])
    chg_impact = df['change.impact'].value_counts()
    colors_chg = plt.cm.RdYlGn_r(np.linspace(0.2, 0.8, len(chg_impact)))
    bars = ax4.bar(range(len(chg_impact)), chg_impact.values, color=colors_chg, alpha=0.7)
    ax4.set_xticks(range(len(chg_impact)))
    ax4.set_xticklabels([str(x)[:15] for x in chg_impact.index], rotation=45, ha='right', fontsize=8)
    ax4.set_ylabel('Count', fontsize=10)
    ax4.set_title('Change Impact Distribution', fontweight='bold')
    ax4.grid(True, alpha=0.3, axis='y')
    
    for bar in bars:
        height = bar.get_height()
        if height > 0:
            ax4.text(bar.get_x() + bar.get_width()/2., height,
                    f'{int(height)}', ha='center', va='bottom', fontsize=8)
    
    # 5. Box Plot
    ax5 = fig.add_subplot(gs[1, 2])
    bp = ax5.boxplot(df['total_hours']/24, vert=True, patch_artist=True)
    bp['boxes'][0].set_facecolor('lightblue')
    bp['boxes'][0].set_alpha(0.7)
    ax5.set_ylabel('Days', fontsize=10)
    ax5.set_title('Time Difference Box Plot', fontweight='bold')
    ax5.grid(True, alpha=0.3, axis='y')
    
    # 6. Hour of Day Distribution
    ax6 = fig.add_subplot(gs[2, 0])
    hour_dist = df['incident_hour'].value_counts().sort_index()
    colors_hour = ['#ff6b6b' if (h < 9 or h > 17) else '#4ecdc4' for h in hour_dist.index]
    ax6.bar(hour_dist.index, hour_dist.values, color=colors_hour, alpha=0.7)
    ax6.set_xlabel('Hour of Day', fontsize=10)
    ax6.set_ylabel('Count', fontsize=10)
    ax6.set_title('Incidents by Hour of Day', fontweight='bold')
    ax6.axvspan(9, 17, alpha=0.2, color='green', label='Business Hours')
    ax6.legend(fontsize=8)
    ax6.grid(True, alpha=0.3, axis='y')
    
    # 7. Day of Week Distribution
    ax7 = fig.add_subplot(gs[2, 1])
    dow_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
    dow_dist = df['incident_day_of_week'].value_counts().reindex(dow_order, fill_value=0)
    colors_dow = ['#4ecdc4' if day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] 
                  else '#ff6b6b' for day in dow_dist.index]
    bars = ax7.bar(range(len(dow_dist)), dow_dist.values, color=colors_dow, alpha=0.7)
    ax7.set_xticks(range(len(dow_dist)))
    ax7.set_xticklabels([d[:3] for d in dow_dist.index], fontsize=9)
    ax7.set_ylabel('Count', fontsize=10)
    ax7.set_title('Incidents by Day of Week', fontweight='bold')
    ax7.grid(True, alpha=0.3, axis='y')
    
    for bar in bars:
        height = bar.get_height()
        if height > 0:
            ax7.text(bar.get_x() + bar.get_width()/2., height,
                    f'{int(height)}', ha='center', va='bottom', fontsize=8)
    
    # 8. Severity Distribution
    ax8 = fig.add_subplot(gs[2, 2])
    severity_counts = Counter([analysis['severity'] for analysis in rca_results['detailed_analysis']])
    severity_order = ['Low', 'Medium', 'High', 'Critical']
    severity_values = [severity_counts.get(s, 0) for s in severity_order]
    colors_sev = ['#44ff44', '#ffaa44', '#ff6b6b', '#8B0000']
    
    bars = ax8.bar(severity_order, severity_values, color=colors_sev, alpha=0.7, edgecolor='black')
    ax8.set_ylabel('Count', fontsize=10)
    ax8.set_title('Delay Severity Classification', fontweight='bold')
    ax8.grid(True, alpha=0.3, axis='y')
    
    for bar in bars:
        height = bar.get_height()
        if height > 0:
            ax8.text(bar.get_x() + bar.get_width()/2., height,
                    f'{int(height)}', ha='center', va='bottom', fontsize=9, fontweight='bold')
    
    plt.savefig('incident_change_timediff_rca.png', dpi=300, bbox_inches='tight')
    print("\n✓ Visualization saved as 'incident_change_timediff_rca.png'")
    plt.show()


def export_rca_report(rca_results, df, filename='incident_change_timediff_rca_report.txt'):
    """Export detailed RCA report to text file."""
    
    with open(filename, 'w') as f:
        f.write("=" * 100 + "\n")
        f.write("INCIDENT-CHANGE TIME DIFFERENCE ROOT CAUSE ANALYSIS REPORT\n")
        f.write("=" * 100 + "\n\n")
        f.write(f"Analysis Date: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        f.write(f"Sample Size: {len(df)} incident-change pairs\n")
        f.write(f"Unique Incidents: {rca_results['patterns']['sample_info']['unique_incidents']}\n")
        f.write(f"Unique Changes: {rca_results['patterns']['sample_info']['unique_changes']}\n")
        f.write(f"Date Range: {rca_results['patterns']['sample_info']['incident_date_range_start']} to ")
        f.write(f"{rca_results['patterns']['sample_info']['incident_date_range_end']}\n\n")
        
        # Executive Summary
        f.write("\n" + "=" * 100 + "\n")
        f.write("EXECUTIVE SUMMARY\n")
        f.write("=" * 100 + "\n")
        stats = rca_results['patterns']['statistics']
        f.write(f"Average Time Difference: {stats['mean_hours']:.2f} hours ({stats['mean_days']:.2f} days)\n")
        f.write(f"Median Time Difference: {stats['median_hours']:.2f} hours ({stats['median_days']:.2f} days)\n")
        f.write(f"Range: {stats['min_hours']:.2f} hours to {stats['max_hours']:.2f} hours ({stats['max_days']:.2f} days)\n")
        f.write(f"Total Root Causes Identified: {len(rca_results['root_causes'])}\n")
        f.write(f"Critical Severity Issues: {sum(1 for rc in rca_results['root_causes'] if rc['severity'] == 'Critical')}\n")
        f.write(f"High Severity Issues: {sum(1 for rc in rca_results['root_causes'] if rc['severity'] == 'High')}\n")
        f.write(f"Total Recommendations: {len(rca_results['recommendations'])}\n")
        f.write(f"P1 Priority Actions: {sum(1 for rec in rca_results['recommendations'] if rec['priority'] == 'P1')}\n\n")
        
        # Time Distribution
        f.write("\n" + "=" * 100 + "\n")
        f.write("TIME DIFFERENCE DISTRIBUTION\n")
        f.write("=" * 100 + "\n\n")
        for bucket, count in rca_results['time_buckets'].items():
            pct = count / len(df) * 100
            f.write(f"{bucket:15}: {count:4} records ({pct:5.1f}%)\n")
        
        # Impact/Priority Analysis
        f.write("\n\n" + "=" * 100 + "\n")
        f.write("IMPACT & PRIORITY ANALYSIS\n")
        f.write("=" * 100 + "\n\n")
        
        f.write("Incident Impact Distribution:\n")
        for impact, count in rca_results['patterns']['impact_priority']['incident_impact'].items():
            pct = count / len(df) * 100
            f.write(f"  {impact}: {count} ({pct:.1f}%)\n")
        
        f.write("\nChange Impact Distribution:\n")
        for impact, count in rca_results['patterns']['impact_priority']['change_impact'].items():
            pct = count / len(df) * 100
            f.write(f"  {impact}: {count} ({pct:.1f}%)\n")
        
        # Root Causes
        f.write("\n\n" + "=" * 100 + "\n")
        f.write("ROOT CAUSES IDENTIFIED\n")
        f.write("=" * 100 + "\n\n")
        
        for i, rc in enumerate(rca_results['root_causes'], 1):
            f.write(f"{i}. [{rc['severity']}] {rc['cause']}\n")
            f.write(f"   Category: {rc['category']}\n")
            f.write(f"   Evidence: {rc['evidence']}\n")
            f.write(f"   Impact: {rc['impact']}\n")
            if 'avg_delay' in rc:
                f.write(f"   Average Delay: {rc['avg_delay']}\n")
            if 'max_delay' in rc:
                f.write(f"   Maximum Delay: {rc['max_delay']}\n")
            f.write("-" * 100 + "\n\n")
        
        # Recommendations
        f.write("\n" + "=" * 100 + "\n")
        f.write("RECOMMENDATIONS (PRIORITIZED)\n")
        f.write("=" * 100 + "\n\n")
        
        for i, rec in enumerate(rca_results['recommendations'], 1):
            f.write(f"{rec['priority']} - Recommendation {i}:\n")
            f.write(f"   {rec['recommendation']}\n")
            f.write(f"   Details: {rec['details']}\n")
            f.write(f"   Expected Impact: {rec['impact']}\n")
            f.write("-" * 100 + "\n\n")
        
        # Statistical Details
        f.write("\n" + "=" * 100 + "\n")
        f.write("DETAILED STATISTICS\n")
        f.write("=" * 100 + "\n\n")
        f.write(f"Mean: {stats['mean_hours']:.2f} hours ({stats['mean_days']:.2f} days)\n")
        f.write(f"Median: {stats['median_hours']:.2f} hours ({stats['median_days']:.2f} days)\n")
        f.write(f"Standard Deviation: {stats['std_hours']:.2f} hours\n")
        f.write(f"Minimum: {stats['min_hours']:.2f} hours\n")
        f.write(f"Maximum: {stats['max_hours']:.2f} hours ({stats['max_days']:.2f} days)\n")
        f.write(f"25th Percentile: {stats['p25_hours']:.2f} hours\n")
        f.write(f"75th Percentile: {stats['p75_hours']:.2f} hours\n")
        f.write(f"95th Percentile: {stats['p95_hours']:.2f} hours\n")
        
        # Outliers
        if 'outliers' in rca_results['patterns']:
            f.write("\n\n" + "=" * 100 + "\n")
            f.write("OUTLIER ANALYSIS\n")
            f.write("=" * 100 + "\n\n")
            outliers = rca_results['patterns']['outliers']
            f.write(f"Number of Outliers: {outliers['count']} ({outliers['percentage']}%)\n")
            f.write(f"Threshold: {outliers['threshold_hours']:.2f} hours ({outliers['threshold_hours']/24:.1f} days)\n")
            f.write(f"Average Outlier Delay: {outliers['avg_hours']:.2f} hours ({outliers['avg_days']:.1f} days)\n")
            f.write(f"Maximum Delay: {outliers['max_hours']:.2f} hours ({outliers['max_days']:.1f} days)\n")
        
        # Record-by-Record Analysis
        f.write("\n\n" + "=" * 100 + "\n")
        f.write("DETAILED RECORD-BY-RECORD ANALYSIS\n")
        f.write("=" * 100 + "\n\n")
        
        for analysis in rca_results['detailed_analysis']:
            f.write(f"\nRecord {analysis['record_index']}:\n")
            f.write(f"  Incident: {analysis['incident_number']} | Change: {analysis['change_number']}\n")
            f.write(f"  Incident Impact: {analysis['incident_impact']} (Priority {analysis['incident_priority']})\n")
            f.write(f"  Change Impact: {analysis['change_impact']} (Priority {analysis['change_priority']})\n")
            f.write(f"  Incident Created: {analysis['incident_created']}\n")
            f.write(f"  Change End: {analysis['change_end']}\n")
            f.write(f"  Time Difference: {analysis['time_difference']}\n")
            f.write(f"  Total: {analysis['total_hours']:.2f} hours ({analysis['total_days']:.2f} days)\n")
            f.write(f"  Classification: {analysis['classification']}\n")
            f.write(f"  Likely Cause: {analysis['likely_cause']}\n")
            f.write(f"  Severity: {analysis['severity']}\n")
            f.write(f"  Concern: {analysis['concern']}\n")
            f.write("-" * 100 + "\n")
    
    print(f"\n✓ Detailed report exported to '{filename}'")


def export_to_excel(rca_results, df, filename='incident_change_timediff_rca_analysis.xlsx'):
    """Export comprehensive analysis to Excel with multiple sheets."""
    
    with pd.ExcelWriter(filename, engine='openpyxl') as writer:
        # Sheet 1: Summary
        summary_data = {
            'Metric': [
                'Total Sample Records',
                'Unique Incidents',
                'Unique Changes',
                'Average Time Difference (hours)',
                'Average Time Difference (days)',
                'Median Time Difference (hours)',
                'Median Time Difference (days)',
                'Min Time Difference (hours)',
                'Max Time Difference (hours)',
                'Max Time Difference (days)',
                'Std Dev (hours)',
                '25th Percentile (hours)',
                '75th Percentile (hours)',
                '95th Percentile (hours)',
                'Root Causes Identified',
                'Critical Severity Issues',
                'High Severity Issues',
                'Recommendations Generated',
                'P1 Priority Actions'
            ],
            'Value': [
                len(df),
                rca_results['patterns']['sample_info']['unique_incidents'],
                rca_results['patterns']['sample_info']['unique_changes'],
                f"{rca_results['patterns']['statistics']['mean_hours']:.2f}",
                f"{rca_results['patterns']['statistics']['mean_days']:.2f}",
                f"{rca_results['patterns']['statistics']['median_hours']:.2f}",
                f"{rca_results['patterns']['statistics']['median_days']:.2f}",
                f"{rca_results['patterns']['statistics']['min_hours']:.2f}",
                f"{rca_results['patterns']['statistics']['max_hours']:.2f}",
                f"{rca_results['patterns']['statistics']['max_days']:.2f}",
                f"{rca_results['patterns']['statistics']['std_hours']:.2f}",
                f"{rca_results['patterns']['statistics']['p25_hours']:.2f}",
                f"{rca_results['patterns']['statistics']['p75_hours']:.2f}",
                f"{rca_results['patterns']['statistics']['p95_hours']:.2f}",
                len(rca_results['root_causes']),
                sum(1 for rc in rca_results['root_causes'] if rc['severity'] == 'Critical'),
                sum(1 for rc in rca_results['root_causes'] if rc['severity'] == 'High'),
                len(rca_results['recommendations']),
                sum(1 for rec in rca_results['recommendations'] if rec['priority'] == 'P1')
            ]
        }
        summary_df = pd.DataFrame(summary_data)
        summary_df.to_excel(writer, sheet_name='Summary', index=False)
        
        # Sheet 2: Time Buckets
        time_buckets_df = pd.DataFrame({
            'Time Range': list(rca_results['time_buckets'].keys()),
            'Count': list(rca_results['time_buckets'].values()),
            'Percentage': [round(v/len(df)*100, 1) for v in rca_results['time_buckets'].values()]
        })
        time_buckets_df.to_excel(writer, sheet_name='Time Distribution', index=False)
        
        # Sheet 3: Root Causes
        root_causes_df = pd.DataFrame(rca_results['root_causes'])
        root_causes_df.to_excel(writer, sheet_name='Root Causes', index=False)
        
        # Sheet 4: Recommendations
        recommendations_df = pd.DataFrame(rca_results['recommendations'])
        recommendations_df.to_excel(writer, sheet_name='Recommendations', index=False)
        
        # Sheet 5: Detailed Analysis
        detailed_df = pd.DataFrame(rca_results['detailed_analysis'])
        detailed_df.to_excel(writer, sheet_name='Detailed Analysis', index=False)
        
        # Sheet 6: Original Sample Data
        df.to_excel(writer, sheet_name='Sample Data', index=False)
        
        # Sheet 7: Outliers (if any)
        if 'outliers' in rca_results['patterns']:
            threshold = rca_results['patterns']['outliers']['threshold_hours']
            outliers_df = df[df['total_hours'] > threshold].copy()
            outliers_df.to_excel(writer, sheet_name='Outliers', index=False)
        
        # Sheet 8: Impact/Priority Summary
        impact_summary = {
            'Category': ['Incident Impact', 'Incident Impact', 'Incident Impact',
                        'Change Impact', 'Change Impact', 'Change Impact'],
            'Value': list(rca_results['patterns']['impact_priority']['incident_impact'].keys())[:3] + 
                    list(rca_results['patterns']['impact_priority']['change_impact'].keys())[:3],
            'Count': list(rca_results['patterns']['impact_priority']['incident_impact'].values())[:3] +
                    list(rca_results['patterns']['impact_priority']['change_impact'].values())[:3]
        }
        impact_df = pd.DataFrame(impact_summary)
        impact_df.to_excel(writer, sheet_name='Impact Analysis', index=False)
    
    print(f"\n✓ Excel report exported to '{filename}'")


# ==================================================================================
# MAIN EXECUTION EXAMPLE
# ==================================================================================

"""
USAGE EXAMPLE:

# 1. Load your sampled incident-change data (with positive time differences)
sample_data_path = 'sample_incident_change_positive.xlsx'

# 2. Perform comprehensive RCA
rca_results = perform_incident_change_timediff_rca(sample_data_path)

# 3. Create visualizations
df = pd.read_excel(sample_data_path)
create_visualizations(df, rca_results)

# 4. Export detailed text report
export_rca_report(rca_results, df)

# 5. Export to Excel (multiple sheets with all analysis)
export_to_excel(rca_results, df)

# 6. Access specific findings
print("\nTop Root Causes:")
for rc in rca_results['root_causes']:
    print(f"- [{rc['severity']}] {rc['cause']}")

print("\nP1 Recommendations:")
for rec in [r for r in rca_results['recommendations'] if r['priority'] == 'P1']:
    print(f"- {rec['recommendation']}")

# 7. Filter extreme cases
detailed = pd.DataFrame(rca_results['detailed_analysis'])
extreme_delays = detailed[detailed['severity'] == 'Critical']
print(f"\nCritical delays: {len(extreme_delays)} records")
print(extreme_delays[['incident_number', 'change_number', 'total_days', 'concern']])
"""
